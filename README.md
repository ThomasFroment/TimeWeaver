![Node.js](https://img.shields.io/badge/Node.js-22.x.x-brightgreen)
![TypeScript](https://img.shields.io/badge/TypeScript-5.8.3-3178c6)
![ESLint](https://img.shields.io/badge/ESLint-Enabled-purple)
![Vitest](https://img.shields.io/badge/Tested_with-Vitest-cc317c)
![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)

![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/ThomasFroment/TimeWeaver/compile.yml?branch=master&label=Build)
![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/ThomasFroment/TimeWeaver/vitest.yml?branch=master&label=Vitest)
![Docker Image Version](https://img.shields.io/github/v/release/ThomasFroment/TimeWeaver?logo=docker&label=docker&color=blue)

# TimeWeaver

This project is a complete rewrite of an older tool built to automate the retrieval of personal planning data from my employer’s website. It extracts scheduling information, stores it with event history, and syncs it to a calendar. The initial version was functional but lacked structure and reliability.

This is a rewrite from the ground up with a focus on maintainability, type safety, and test coverage, addressing shortcomings in the original implementation.  The project originated from the need to avoid relying on a planning system that was often slow, frequently unavailable, and poorly optimized for mobile use.

# Technologies Used

- **Languages**: TypeScript (Strict)
- **Frameworks/Libraries**:
    - **Google APIs**: Google Calendar API
    - **Luxon**: Facilitates date and time manipulation
    - **MongoDB**: NoSQL database
    - **Puppeteer**: Headless browser automation for web scraping
    - **Winston**: Logging library
    - **Zod**: Runtime validation for TypeScript
- **Tools**:
    - **ESLint** : Code quality and linting
    - **Vitest** : Testing framework
    - **Docker** : Containerization

# Features

- **Environment Variables**: Uses environment variables to securely manage sensitive data, such as API keys and owner email.

- **Website Scraping**: Scrapes a website to retrieve scheduling information, including both events and absences.

- **Event Parsing**: Parses the scraped JSON data to identify and categorize events, distinguishing between time range events and all-day events, and filtering for valid absence types.

- **Database Storage**: Stores events in a MongoDB database, keeping historical data.

- **Google Calendar Sync**: Synchronizes the schedule with Google Calendar, updating events with modifications and including the event's creation time in the description.

> [!NOTE]
> At this time, the project is not designed to sync multiple people’s calendars. While the database can handle multiple users by using the username as a collection, the API side requires a separate service account and app runtime for each person.
>
> This limitation could be easily addressed, but it hasn't been necessary given the project's intended scope.

# MongoDB

The project uses MongoDB to store the scraped data. The database is structured as follows:

```typescript
interface DBCalendarDocument {
  _id?: ObjectId;                     // The unique identifier for the document (automatically generated by MongoDB)
  date: {
    ISOMonth: string;                 // The month in ISO format (e.g., "2023-10")
    day: string;                      // The day of the month (e.g., "08")
  };
  event: {
    label?: string;                   // Optional label for the event (e.g., "ABSINJH")
    start?: string;                   // Optional start time (e.g., "16:00")
    end?: string;                     // Optional end time (e.g., "17:00")
    isCreated: boolean;               // Indicates if the event has been created in the calendar (true/false)
  };
  isActive: boolean;                  // Indicates whether the event still exists on the website (true/false)
  createdAt: string;                  // The timestamp of when the document was created
  updatedAt: string;                  // The timestamp of when the document was last updated
}
```

# Docker

This project uses a multi-stage Docker build to optimize image size and simplify deployment. The build process is divided into two stages:

1. **Build Stage**: In this stage, we compile the TypeScript code into JavaScript using the `tsc` command.
2. **Production Stage**: In the second stage, we install the necessary dependencies, including Chromium (required by Puppeteer for web scraping). The application is then set up to run as a non-root user for security purposes.

```yaml
services:
  mongo:
    image: mongo:latest
    container_name: mongo-timeweaver
    volumes:
      - timeweaver-db:/data/db
    networks:
      - timeweaver-network
  timeweaver:
    image: ghcr.io/thomasfroment/timeweaver:latest
    container_name: timeweaver
    env_file: .env
    volumes:
      - timeweaver-data:/home/pptruser/app/data
    networks:
      - timeweaver-network
    depends_on:
      - mongo
volumes:
  timeweaver-data:
  timeweaver-db:

networks:
  timeweaver-network:
    driver: bridge
```

To prevent data loss when the containers are stopped, the following volumes should be mounted:

**For the application container**:

- `/home/pptruser/app/data`: This volume stores the `calendar_id` associated with the calendar created by the service account.

- `/home/pptruser/app/logs`: This *optional* volume stores the logs generated by the application.

**For the MongoDB container**:

- `/data/db`: This volume is used to store the MongoDB database files.

# Environment Variables

- `API_EMAIL`: The email address of the Google API service account.
- `API_KEY`: The API key for the Google API service account.
- `OWNER_EMAIL`: The email adress will be granted ownership of the calendar.
- `CHD`: The username of the account to be used for scraping.
- `CHD_PASSWORD`: The password of the account to be used for scraping.
- `CHD_WEBSITE`: The URL of the website to be scraped.
- `MONGO_URI`: The MongoDB connection string (e.g., `mongodb://localhost:27017`).
- `NODE_ENV`: The environment in which the application is running (e.g., `development`, `production`).

# License

This project is licensed under the GPL-3.0 License. See the [LICENSE](LICENSE.md) file for details.